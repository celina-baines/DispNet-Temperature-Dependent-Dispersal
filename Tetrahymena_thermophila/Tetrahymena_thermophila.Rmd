---
title: "Temperature dependent dispersal: A distributed experiment"
author: "Nicolas Schtickzelle"
output: word_document
editor_options: 
  chunk_output_type: console
---

```{r instructions, echo = F, warning = F}

# INSTRUCTIONS FOR RESEARCHERS

# Here, you'll find instructions and information to fill out about your species. Once you have finished following the instructions, go to the render_script in your species folder and run the code - this will automatically knit a word document to the shared Knitted_Markdowns folder. You don't need to make any changes to the analysis outside of this code chunk, but feel free to do so if it's appropriate for your species. If you make substantive changes to either of the models, please flag it for Celina.

# Note: Do not try to "run all" within R, you will get an error. Knitting the document from the RStudio menu will only save it to your species folder, not add it to the shared folder, so please use render_script.

# 0. Add names of researchers who worked on this species to author list above

# 1. Before starting, make sure your data files are named:
# Phase1_fitness_Genus.species.csv
# Phase2_dispersal_Genus.species.csv

## code below assumes .csv format (only in the code chunk named 'loaddata'; You can change this if you would rather not use .csv)


# 2. Install any missing libraries from the list below:
library(tidyverse)
library(lme4)
library(ggplot2)
library(emmeans)
library(DHARMa)

# 3. Fill out information about your species below

Genus = "Tetrahymena"
species = "thermophila"
fitness.proxy = "Population growth, r"
low.temp = 23 #value of low temperature treatment in Celsius
opt.temp = 31 #value of optimal temperature treatment in Celsius
high.temp = 39 #value of high temperature treatment in Celsius


# 4. Check that the data files have the following headers (order of columns is not important):

## phase1 : Temp.treatment (levels = low, opt, high), Temp.value (in degrees C), random effects (name as appropriate), Fitness
### It's important to give the column of the fitness variable the header "Fitness". You have already provided a description of the fitness proxy which will be used in the knitted document.

## phase 2:

### If your phase 2 data are formatted with mesocosms as rows and number of dispersers/number of non-dispersers as columns, then these headers:
#### Temp.treatment (levels = low, opt, high), Temp.value (in degrees C), random effects (name as appropriate), Num.disp, Num.nondisp (or alternatively, Num.disp and total N)

### If your phase 2 data are formatted with individuals as rows and a dispersed column (0s and 1s) giving dispersal status for each individual, then these headers:
#### Temp.treatment (levels = low, opt, high), Temp.value (in degrees C), random effects (name as appropriate), Dispersed (0/1)

# note that the datasets can also include fixed effects and phenotypes, as appropriate for your study


# 5. Type of fitness data

## Answer questions below about the fitness proxy

### Is your fitness variable binary? (choose one)
fitness.binary = FALSE

### Is the fitness variable continuous normal (without transformation)? (choose one)
fitness.normal = TRUE

### Is the fitness variable normal after transformation? (choose one; choose NA if you said "TRUE" to either question above)
fitness.transformed.normal = NA

## If fitness variable is continuous normal AFTER transformation, choose transformation used (just write it in if not on this list):

transform.description <- "square-root/log/log10" # leave as-is if not applicable
fitness.transformation.function <- function(x) {return (log(x))} # give transformation formula here; replace "log" with transformation used e.g., sqrt(x) or log(x + 1), etc., where x will be Fitness, below

## note: if fitness (or transformed fitness) does not have a binomial or normal distribution, check in with Celina.


# 6. Structure of dispersal data

## Is there overdispersion in the dispersal data? If you do not yet know, choose FALSE and this will be dealt with in step 12.

overdispersion = FALSE


# 7. Dealing with mortality in dispersal assay

## note on mortality: everyone will deal with mortality during the dispersal assay in a slightly different way. If individuals are rows in your dataset, you should have a row that indicates "Survived" (Y/N) through the entire experiment. In this case, set filter.dead = TRUE below. If mesocosms are rows in your dataset, you may have a column indicating the number of individuals that died. In this case, dead individuals can be excluded directly in the dispersal formula (e.g., (Num.disp, TotalN-(Num.disp+Num.dead))).

## Make sure to describe how you dealt with mortality in the methods below.

## If you are unsure how to handle mortality in your dataset, check with Celina.

## Do rows represent individuals in the dataset and are there dead individuals that should be removed from the dispersal data?

filter.dead = FALSE # choose FALSE if this does not apply to your species


# 8. Model formulae

## Formula for fitness: (fill in as appropriate)

fitness.formula <- "Fitness ~ Temp.treatment + other.fixed.effects + (1|random)"

### notes:
#### TRANSFORM FITNESS VARIABLE (if needed) *WITHIN* THE FORMULA; doing it within the formula is important for contrasts below  
#### other.fixed.effects does not apply to every species; include as appropriate; fixed effects should be standardized
#### include as many random effects as appropriate
#### Fitness can be normal or binary, including 0s and 1s or cbind(number.survived, number.dead)

### If fitness is binary: (ignore if fitness is not binary)

### What do Fitness = 0 and Fitness = 1 mean?

Fit0 <- "Died/Survived" # or fill in other
Fit1 <- "Died/Survived" # or fill in other

## Formula for dispersal: (fill in as appropriate)
  
dispersal.formula <- "cbind(Num.disp, Num.nondisp) ~ Temp.treatment + other.fixed.effects + (1|random)"

### notes
#### other.fixed.effects does not apply to every species; include as appropriate; fixed effects should be standardized
#### include as many random effects as appropriate
#### Num.disp/Num.nondisp can be replaced with column "Dispersed" with values 0 and 1, if individuals are rows in your dataset
#### remember to deal with mortality directly in dispersal formula if appropriate


# 9. Moderators

## We are collecting data on all proposed moderators; we will use a subset of these in the analysis
## choose option on right hand side
## see description of moderators and levels in README.md in project repo

taxonomic.group <- "ciliate"
rearing.environment <- "commonT"
comp.strength <- "moderate"
source <- "lab" # lab population or field caught
habitat <- "aquatic"
Tvariation <- "homogenous"
species.body.size <- 0.05 # mean body length in mm
passive.dispersal <- "No"

## ? for Celina: do you consider an strain (isogenic line) as inbred ? Because our strains have been created from 1 cell isolated from the field. But there are many Tetrahymena strains that were creating by inbreeding among close lines int he lab.
inbred <- "inbred line/mixed"

disp.assay.duration <- 1 # order of magnitude for dispersal assay duration / generation time, i.e., approximate number of generations the dispersal assay lasted
fitness.proxy.type <- "r"

# 10. Fill out methods information in text below.

```

# Supplementary methods for *`r (print(paste(Genus, species)))`*

## Author contributions
N.S. : conceptualization, methodology, conduct experiment, statistical analysis and visualization, writing, funding acquisition, project administration

## Acknowledgements
N.S. thanks Julie Jadoul for general culture and laboratory maintenance and Julie Jadoul and Michaëlla Dacek for helping with conducting the experiment.

## Study organism
*Tetrahymena thermophila* is a unicellular ciliate eukaryote whose natural habitat is freshwater ponds and streams in the east regions of North America where it feeds on aggregates of bacteria and dissolved nutrients. It actively disperses via swimming and has a generation time of c. 8h in our lab conditions. It lives originally in streams, ponds and lakes on the Atlantic coast of North America, where it disperses actively. We used five strains (D3, D13, D16, D19, D21), i.e. isogenic lines of cells bearing a single genotype, that differ in various phenotypic traits; they were originally collected in the field by F.P. Doerder from 2003 to 2009. Upon their arruvak in our lab, they were cryoconserved in liquid nitrogen. Stock cultures from this experiment were thawed and maintained for a few months (at 23°C 14:10 day/night light cycle) in an axenic PPYE liquid medium (2% of Proteose Peptone and 0.2% of Yeast Extract, diluted in ultrapure water, referred to as “1X medium” for its standard resource concentration); cultures were reinoculated into new medium every 10 days on average. All culture manipulations were performed  under a laminar flow hood to maintain their axenic condition (Schtickzelle et al., 2009).


## Study design

### Temperature treatments
As temperature treatments, we used Topt = 31C, Thot = 39C, and Tcold = 23C. Tcold is the culture temperature, Topt is around the temperature at which the growth rate is maximal (which differs among strains: Jacob et al. 2018), Thot is the temperature at which some growth is still possible, but it is on the descending side of the TPC. There was no daily variation in temperature. 


### Phase 1: Fitness assay
As a fitness proxy, we used maximum growth rate (r), i.e. the exponential population growth observed of a population starting from very low density. For each of the 3 temperatures, we established two biological replicate cultures of each of the 5 strains, and inoculated two wells (technical replicates) of a 24 well plate (Greiner 662102) with 2 ml of 0.3X culture medium and 100µl of stock culture. We recorded population growth, using optical density measurements (OD at 550nm, using a Biotek Synergy H1 multiplate reader: Jacob et al. 2018) as a cell density proxy, every 3 to 24h (interval increasing over time) over a period of 23 days maximum at 15°C. One plate was used for each temperature and each plate contained 4 wells with medium only used a blank to correct OD. For every read, the OD was the average of 9 measurements spread as a grid over the well area. 

Time series of OD Maximum growth rate (r) was calculated as the maximum linear slope of the temporal increase of the log-transformed optical density with the easy linear fit in the `growthrates` package, per temperature, strain and replicate separately.  

based on time series data at different temperatures starting from low densities (~100 individuals per ml). Experiments were conducted in plastic vials (Sarstedt), filled with 20ml of the bacterized medium described above and kept in dark incubators at the respective treatment temperatures. We replicated each temperature treatment five times. To avoid pseudoreplication, we switched incubators randomly every two days. To maintain the resource at a constant level, every two days, we replenished 10% of the culture with fresh medium that was enriched with bacteria at the same 9:1 ratio as above. The experiment lasted 9 days (until the populations at the coldest temperature had reached carrying capacity). We additionally measured densities and phenotypes by recording videos under a stereoscope and analyzing those videos with the `bemovi` software. That yielded (apart from densities) measurements of cell size as well as swimming speed.

Describe the fitness proxy (growth rate, survival, body condition, reproductive output, etc.). If proxy is indirect (e.g., body condition), explain what is known about the relationship between the proxy and actual fitness in the species.  

Provide details about the methods for estimating the fitness proxy including:  
-	Physical details about the experimental setup including size/shape/volume of experimental arenas, substrate/medium of experimental arenas.  
-	Replicates  
    - Specify number of experimental replicates  
    - Number of strains and number of replicates per strain  
    - Indicate if experimental blocks were used and the blocking design (number of blocks, how many replicates of each treatment per block, time/space between blocks)
-	Type and amount of food provided during experiment  
- Starting density  
-	Duration of fitness assay  
-	Controlled variables: food (ad lib?), water (ad lib?), sex ratio  
- Phenotypes measured (activity, body condition, body size, etc.) and how they were estimated  

### Phase 2: Dispersal assay

Provide details about the methods for estimating dispersal including:  
-	Physical details about the experimental setup including size/shape/volume of experimental arenas, substrate/medium of experimental arenas, type of system (1 or 2 patches).  
-	Replicates  
    - Specify number of experimental replicates  
    - Number of strains and number of replicates per strain  
    - Indicate if experimental blocks were used and the blocking design (number of blocks, how many replicates of each treatment per block, time/space between blocks)  
-	Type and amount of food provided during experiment  
- Starting density  
-	Duration of dispersal assay including:  
    - time between birth and start of acclimation period  
    - duration of acclimation period  
    - timing and duration of dispersal assay  
-	Controlled variables: food (ad lib?), water (ad lib? if applicable), sex ratio  
- Phenotypes measured (activity, body condition, body size, etc.) and how they were estimated  
- Whether individuals used in phase 2 were the same as used in phase 1 
- Provide details on data collection including:  
    -	The sampling regime (time intervals between sampling).  
    -	Sampling method including whether individuals were marked and whether sampling was observed or automated. Please include validation if automated.  
- State whether mortality during the dispersal assay was recorded. Describe how mortality was handled for the statistical analysis (e.g., individuals that died during the dispersal assay were excluded from the analysis of dispersal).  



```{r instructions2, echo = F}

# 11. Knit RMarkdown

## Now it is time to knit the RMarkdown document. Open the render_script document in the species folder and run that script (see README.md for additional instructions). It will automatically write the files to the correct folders in the repository. Remember not to 'run all' in the RMarkdown. You will get an error.

# 12. Check diagnostics

## The final section of the output doc will be model diagnostics. Check the output word doc (it will be in the 'Knitted_Markdowns' folder) for any issues and re-run the render_script if necessary after selecting different options in the RMarkdown (e.g., does the fitness variable need to be transformed? Is there overdispersion in the dispersal data?)

## You should also check the word doc for warning messages for the models (e.g., singularity in mixed models). These (if there are any) will print in the knitted doc next to the model results.

## If problems persist, the way the analysis is done may have to be changed (check in with Celina).

## Note that the current default description of the diagnostics is: "There was no evidence for lack of fit for either the fitness or the dispersal model." Change this as needed.


#############

# YOU ARE DONE! NO NEED TO FILL IN OR CHANGE ANYTHING BELOW.

############

```

## Statistical Analysis

```{r loaddata, echo = F}

# Set reading and writing paths; Do not change these paths
reading.path <- ("./")

writing.path <- ("../outputs/")

# load data file
d_phase1 <- read.csv(paste("Phase1_fitness_", Genus, ".", species, ".csv", sep = ""))
d_phase2 <- read.csv(paste("Phase2_dispersal_", Genus, ".", species, ".csv", sep = ""))

d_phase1 <- within(d_phase1, Temp.treatment <- relevel(as.factor(Temp.treatment), ref = "opt"))
d_phase2 <- within(d_phase2, Temp.treatment <- relevel(as.factor(Temp.treatment), ref = "opt"))

d_phase2 <- d_phase2 %>%
  { if (filter.dead) filter(., Survived == "Y") else . }

```

```{r writedata, echo = F}

# specify fitness and dispersal file names
fitpath <- paste("Phase1_fitness_", Genus, ".", species, ".csv", sep = "")
disppath <- paste("Phase2_dispersal_", Genus, ".", species, ".csv", sep = "")

data_path <- "../raw_data/" #path to save the data is to the raw_data folder

#save copy of final dfs used in this file to the raw_data folder
write.csv(d_phase1, paste(data_path, fitpath, sep = ""), row.names = FALSE)
write.csv(d_phase2, paste(data_path, disppath, sep = ""), row.names = FALSE)

```


### Does fitness change with temperature (phase 1)?

`r ifelse(fitness.transformed.normal == TRUE, print(paste(fitness.proxy, " was not normally distributed so we ", transform.description, "-transformed it. The transformed variable followed a normal distribution.", sep = "")), ifelse(fitness.normal == TRUE, print(paste(fitness.proxy, "was normally distributed.")), print(paste("The fitness proxy,", tolower(fitness.proxy), ", was a binary variable."))))`

```{r fitnessnormal, eval = fitness.normal, echo = F, fig.cap = paste("Figure 1. Histogram of fitness (", tolower(fitness.proxy), ") values.")}

# histogram showing fitness proxy was normally distributed

with(d_phase1, hist(Fitness, xlab = fitness.proxy, main = NULL))

```


```{r transformedfitnessnormal, eval = fitness.transformed.normal, echo = F, fig.cap = paste("Figure 1. Histogram of", transform.description, "-transformed", tolower(fitness.proxy), "values.")}

# histogram showing transformed fitness proxy was normally distributed

with(d_phase1, hist(fitness.transformation.function(Fitness), xlab = paste(transform.description, "-transformed ", tolower(fitness.proxy), sep = ""), main = NULL))

```

```{r fitnessplotnormal, eval = fitness.normal | fitness.transformed.normal, echo = F, message = F, fig.cap = paste("Figure 2. Boxplot of fitness (", tolower(fitness.proxy), "), as a function of temperature treatment. low = ", low.temp, "C, opt = ", opt.temp, "C, high = ", high.temp, "C.")}

# plot fitness data

ggplot(d_phase1, aes(x = Temp.treatment, y = Fitness, col = Temp.treatment))+
  geom_boxplot()+
  scale_x_discrete("Temperature treatment", limits = c("low", "opt", "high"))+
  scale_color_manual(values = c("darkgreen", "red", "blue"), guide = "none")+
  theme_classic(base_size = 15)

```

`r ifelse(fitness.binary == T, print(paste("To estimate the effects of temperature (a factor) on fitness we used a generalized linear mixed model with a logit link and", tolower(fitness.proxy), "as the binary response variable. We used the formula:")), paste("To estimate the effects of temperature (a factor) on fitness, we used a linear mixed model with", tolower(fitness.proxy), "as the response variable. We used the formula:"))`  

`r (print(fitness.formula))`

```{r fitnessmodelnormal, eval = fitness.normal | fitness.transformed.normal, echo = F}

# model testing effects of temperature on fitness

m_fitness <- lmer(fitness.formula, data = d_phase1)

# output results for overall model and pairwise comparisons

output_fitness_Tempeffect <- anova(m_fitness)
output_fitness_summary <- summary(m_fitness)
output_fitness_emmeans <- emmeans(m_fitness, specs = pairwise ~ Temp.treatment, regrid = "response", adjust = "none")
output_fitness_contrasts <- output_fitness_emmeans$contrasts %>%
     summary(infer = TRUE)
```


```{r fitnesstablebinary, eval = fitness.binary, echo = F}

fittable <- with(d_phase1, table(Temp.treatment, Fitness))
knitr::kable(fittable, col.names = c(Fit0, Fit1),
 caption = paste("Table 1. Relationship between", tolower(fitness.proxy), "and temperature treatment.")) 


```


```{r fitnessmodelbinary, eval = fitness.binary, echo = F}

# model testing effects of temperature on fitness

m_fitness <- glmer(fitness.formula, family = binomial, data = d_phase1)

# output results for overall model and pairwise comparisons

output_fitness_Tempeffect <- drop1(m_fitness, test = "Chisq")
output_fitness_summary <- summary(m_fitness)
output_fitness_emmeans <- emmeans(m_fitness, specs = pairwise ~ Temp.treatment, type = "response", adjust = "none")
output_fitness_contrasts <- output_fitness_emmeans$contrasts %>%
     summary(infer = TRUE)

```

#### Results for main effect of temperature on fitness
```{r fitnessresultsmaineffect, echo = F}

output_fitness_Tempeffect

```

#### Post-hoc pairwise contrasts: differences in fitness between temperature treatments
```{r fitnessresultscontrasts, echo = F}

output_fitness_contrasts

```


### Does dispersal change with temperature (phase 2)?

`r ifelse(!overdispersion, print("To estimate the effect of temperature treatment (a factor) on dispersal, we used a generalized linear mixed model with a binomial error structure and a logit link. Dispersal (the number of dispersers vs non-dispersers) was the response variable. We used the formula:"), print("There was evidence of overdispersion in our dispersal data. Therefore, to estimate the effect of temperature treatment (a factor) on dispersal, we used a generalized linear mixed model with a negative binomial error structure. Dispersal (the number of dispersers vs non-dispersers) was the response variable. We used the formula:"))`  

`r (print(dispersal.formula))`


```{r dispersalmodelbinomial, eval = !overdispersion, echo = F}

# binomial model testing effects of temperature on dispersal

m_dispersal <- glmer(dispersal.formula, family = "binomial", data = d_phase2)

# output results for overall model and pairwise comparisons
output_dispersal_Tempeffect <- drop1(m_dispersal, test = "Chisq")
output_dispersal_summary <- summary(m_dispersal)
output_dispersal_emmeans <- emmeans(m_dispersal, specs = pairwise ~ Temp.treatment, type = "response", adjust = "none")
output_dispersal_contrasts <- output_dispersal_emmeans$contrasts %>%
  summary(infer = TRUE)


```

```{r dispersalmodelnegbinomial, eval = overdispersion, echo = F}

# negative binomial model testing effects of temperature on dispersal

m_dispersal <- glmer.nb(dispersal.formula, data = d_phase2)

# output results for overall model and pairwise comparisons
output_dispersal_Tempeffect <- drop1(m_dispersal, test = "Chisq")
output_dispersal_summary <- summary(m_dispersal)
output_dispersal_emmeans <- emmeans(m_dispersal, specs = pairwise ~ Temp.treatment, type = "response", adjust = "none")
output_dispersal_contrasts <- output_dispersal_emmeans$contrasts %>%
  summary(infer = TRUE)

```

```{r dispersalplot, echo = F, warning = F, fig.cap = paste("Figure 1. Dispersal as a function of temperature treatment. low = ", low.temp, "C, opt = ", opt.temp, "C, high = ", high.temp, "C. Error bars represent 95% confidence intervals predicted from GLMM.")}

# plot dispersal data

ggplot(as.data.frame(output_dispersal_emmeans$emmeans), aes(x = Temp.treatment, y = prob, col = Temp.treatment))+
  geom_point(size = 4)+
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0)+
  scale_x_discrete("Temperature treatment", limits = c("low", "opt", "high"))+
  scale_y_continuous("Dispersal probability")+
  scale_color_manual(values = c("darkgreen", "red", "blue"), guide = "none")+
  theme_classic(base_size = 15)

```

#### Results for main effect of temperature on dispersal
```{r dispersalresultsmaineffect, echo = F}

output_dispersal_Tempeffect

```

#### Post-hoc pairwise contrasts: differences in dispersal between temperature treatments
```{r dispersalresultscontrasts, echo = F}

output_dispersal_contrasts

```

### Model Diagnostics

There was no evidence for lack of fit for either the fitness or the dispersal model.

#### Diagnostic plots for fitness data

```{r modeldiagnosticsfitness, echo = F, fig.width = 8, fig.height = 7}

diagnostic_fitness <- simulateResiduals(fittedModel = m_fitness)
plot(diagnostic_fitness)
```

#### Diagnostic plots for dispersal data

```{r modeldiagnosticsdispersal, echo = F, fig.width = 8, fig.height = 7}

diagnostic_dispersal <- simulateResiduals(fittedModel = m_dispersal)
plot(diagnostic_dispersal)

```

```{r moderators, echo = F}

d_moderator <- data.frame(
  "Species" = paste(Genus, species),
  "Taxonomic group" = taxonomic.group,
  "Rearing.environment" = rearing.environment,
  "Competition.strength" = comp.strength,
  "Source" = source,
  "Habitat" = habitat,
  "Temperature.variation" = Tvariation,
  "Species mean body size" = species.body.size,
  "Passive.dispersal" = passive.dispersal,
  "Inbred.or.Mixed" = inbred,
  "Dispersal.assay.duration" = disp.assay.duration,
  "Fitness.proxy.type" = fitness.proxy.type
)

```

```{r writingoutputfiles, echo = F}

# fitness output

write.table(output_fitness_Tempeffect, paste(writing.path, "output_fitness_TempMain_", Genus, ".", species, ".txt", sep = ""))

write.table(output_fitness_summary$coefficients, paste(writing.path, "output_fitness_Summary_", Genus, ".", species, ".txt", sep = ""))

write.table(output_fitness_emmeans$emmeans, paste(writing.path, "output_fitness_emmeans_", Genus, ".", species, ".txt", sep = ""))

write.table(output_fitness_emmeans$contrasts, paste(writing.path, "output_fitness_contrasts_", Genus, ".", species, ".txt", sep = ""))


# dispersal output

write.table(output_dispersal_Tempeffect, paste(writing.path, "output_dispersal_TempMain_", Genus, ".", species, ".txt", sep = ""))

write.table(output_dispersal_summary$coefficients, paste(writing.path, "output_dispersal_Summary_", Genus, ".", species, ".txt", sep = ""))

write.table(output_dispersal_emmeans$emmeans, paste(writing.path, "output_dispersal_emmeans_", Genus, ".", species, ".txt", sep = ""))

write.table(output_dispersal_emmeans$contrasts, paste(writing.path, "output_dispersal_contrasts_", Genus, ".", species, ".txt", sep = ""))


# moderator output

write.table(d_moderator, paste(writing.path, "moderators_", Genus, ".", species, ".txt", sep = ""))

```
