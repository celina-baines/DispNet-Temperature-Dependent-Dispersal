---
title: "Temperature dependent dispersal: A distributed experiment"
author: "Celina Baines, Nicole Regimbal"
output: word_document
editor_options: 
  chunk_output_type: console
---

```{r instructions, echo = F, warning = F}

# INSTRUCTIONS FOR RESEARCHERS

# Here, you'll find instructions and information to fill out about your species. Once you have finished following the instructions, go to the render_script in your species folder and run the code - this will automatically knit a word document to the shared Knitted_Markdowns folder. You don't need to make any changes to the analysis outside of this code chunk, but feel free to do so if it's appropriate for your species. If you make substantive changes to either of the models, please flag it for Celina.

# Note: Do not try to "run all" within R, you will get an error. Knitting the document from the RStudio menu will only save it to your species folder, not add it to the shared folder, so please use render_script.

# 0. Add names of researchers who worked on this species to author list above

# 1. Before starting, make sure your data files are named:
# Phase1_fitness_Genus.species.csv
# Phase2_dispersal_Genus.species.csv

## code below assumes .csv format (only in the code chunk named 'loaddata'; You can change this if you would rather not use .csv)


# 2. Install any missing libraries from the list below:
library(tidyverse)
library(lme4)
library(ggplot2)
library(emmeans)
library(DHARMa)

# 3. Fill out information about your species below

Genus = "Notonecta"
species = "undulata"
fitness.proxy = "Fecundity"
low.temp = 16 #value of low temperature treatment in Celsius
opt.temp = 26 #value of optimal temperature treatment in Celsius
high.temp = 30 #value of high temperature treatment in Celsius


# 4. Check that the data files have the following headers (order of columns is not important):

## phase1 : Temp.treatment (levels = low, opt, high), Temp.value (in degrees C), random effects (name as appropriate), Fitness
### It's important to give the column of the fitness variable the header "Fitness". You have already provided a description of the fitness proxy which will be used in the knitted document.

## phase 2:

### If your phase 2 data are formatted with mesocosms as rows and number of dispersers/number of non-dispersers as columns, then these headers:
#### Temp.treatment (levels = low, opt, high), Temp.value (in degrees C), random effects (name as appropriate), Num.disp, Num.nondisp (or alternatively, Num.disp and total N)

### If your phase 2 data are formatted with individuals as rows and a dispersed column (0s and 1s) giving dispersal status for each individual, then these headers:
#### Temp.treatment (levels = low, opt, high), Temp.value (in degrees C), random effects (name as appropriate), Dispersed (0/1)

# note that the datasets can also include fixed effects and phenotypes, as appropriate for your study


# 5. Type of fitness data

## Answer questions below about the fitness proxy

### Is your fitness variable binary? (choose one)
fitness.binary = FALSE

### Is the fitness variable continuous normal (without transformation)? (choose one)
fitness.normal = FALSE

### Is the fitness variable normal after transformation? (choose one; choose NA if you said "TRUE" to either question above)
fitness.transformed.normal = TRUE

## If fitness variable is continuous normal AFTER transformation, choose transformation used (just write it in if not on this list):

transform.description <- "ln" # leave as-is if not applicable
fitness.transformation.function <- function(x) {return (log(x+1))} # give transformation formula here; replace "log" with transformation used e.g., sqrt(x) or log(x + 1), etc., where x will be Fitness, below

## note: if fitness (or transformed fitness) does not have a binomial or normal distribution, check in with Celina.


# 6. Structure of dispersal data

## Is there overdispersion in the dispersal data? If you do not yet know, choose FALSE and this will be dealt with in step 12.

overdispersion = FALSE


# 7. Dealing with mortality in dispersal assay

## note on mortality: everyone will deal with mortality during the dispersal assay in a slightly different way. If individuals are rows in your dataset, you should have a row that indicates "Survived" (Y/N) through the entire experiment. In this case, set filter.dead = TRUE below. If mesocosms are rows in your dataset, you may have a column indicating the number of individuals that died. In this case, dead individuals can be excluded directly in the dispersal formula (e.g., (Num.disp, TotalN-(Num.disp+Num.dead))).

## Make sure to describe how you dealt with mortality in the methods below.

## If you are unsure how to handle mortality in your dataset, check with Celina.

## Do rows represent individuals in the dataset and are there dead individuals that should be removed from the dispersal data?

filter.dead = TRUE # choose FALSE if this does not apply to your species


# 8. Model formulae

## Formula for fitness: (fill in as appropriate)

fitness.formula <- "log(Fitness+1) ~ Temp.treatment + (1|Mesocosm)"

### notes:
#### TRANSFORM FITNESS VARIABLE (if needed) *WITHIN* THE FORMULA; doing it within the formula is important for contrasts below  
#### other.fixed.effects does not apply to every species; include as appropriate; fixed effects should be standardized
#### include as many random effects as appropriate
#### Fitness can be normal or binary, including 0s and 1s or cbind(number.survived, number.dead)

### If fitness is binary: (ignore if fitness is not binary)

### What do Fitness = 0 and Fitness = 1 mean?

Fit0 <- "Died/Survived" # or fill in other
Fit1 <- "Died/Survived" # or fill in other

## Formula for dispersal: (fill in as appropriate)
  
dispersal.formula <- "Dispersed ~ Temp.treatment + (1|Mesocosm)"

### notes
#### other.fixed.effects does not apply to every species; include as appropriate; fixed effects should be standardized
#### include as many random effects as appropriate
#### Num.disp/Num.nondisp can be replaced with column "Dispersed" with values 0 and 1, if individuals are rows in your dataset
#### remember to deal with mortality directly in dispersal formula if appropriate


# 9. Moderators

## We are collecting data on all proposed moderators; we will use a subset of these in the analysis
## choose option on right hand side
## see description of moderators and levels in README.md in project repo

taxonomic.group <- "arthropod"
rearing.environment <- "field"
comp.strength <- "low" # tested alone
source <- "field" # lab population or field caught
habitat <- "aquatic"
Tvariation <- "heterogenous"
species.body.size <- 11 # mean body length in mm
passive.dispersal <- "No"
inbred <- "mixed"
disp.assay.duration <- 0.01 # order of magnitude for dispersal assay duration / generation time, i.e., approximate number of generations the dispersal assay lasted
fitness.proxy.type <- "other"

# 10. Fill out methods information in text below.

```

# Supplementary methods for *`r (print(paste(Genus, species)))`*

## Author contributions
CB conceptualized the project. NR and CB designed the methodology. NR conducted the experiment and collected the data. CB conducted the statistical analysis. NR and CB wrote the supplementary material.

## Acknowledgements
Funding was provided by a National Science and Engineering Council of Canada Discovery Grant awarded to CB.

## Study organism
Our experiment used backswimmers (Notonecta undulata) that were field caught from experimental ponds at the University of Toronto’s Koffler Scientific Reserve (KSR; 44°01’N, 79°32’W) in King City, Ontario. Backswimmers are semi-aquatic insects that are common in freshwater ponds throughout North America (Hungerford 1919). In these habitats, backswimmers are voracious generalist predators that has strong impacts on community structure (Hungerford 1934, Blaustein et al. 1995). They also commonly exhibit opportunistic cannibalism (Zalom 1978). Backswimmers fly to disperse between patches of aquatic habitat (Hungerford 1934), but this process is energetically intensive (Baines et al. 2015) and requires a light cue (Essenberg 1915). At high temperatures, the predatory behaviors of backswimmers increase, imposing greater top-down effects on the community (Ingram and Burns 2018). At high temperatures, some species of backswimmer have shown an increase in paddling rate (Krishnan and Narayanan 2024), swimming duration (Bailey 1988) and swimming speed (Ferris and Wilson 2012).  
  
Backswimmers for Phase 1 were sourced in May and individuals for Phase 2 were sourced in August. Prior to the start of the experiment, backswimmers were separated into individual holding containers, which they remained in throughout the duration of the experiment, at ambient temperatures to reduce stress for a minimum of 24 hours. Backswimmers in Phase 2 underwent 4 acclimation days in their temperature treatments prior to the dispersal assay. While acclimating, backswimmers were fed ad libitum. For Phase 1, we specifically used female adult backswimmers since we were measuring reproductive output. Phase 2 used any adult backswimmer regardless of sex. 

## Study design

### Phase 1 - Fitness assay
We assessed the effects of temperature on survival, body condition, and reproductive rate for female backswimmers over a 2-week long fitness assay. Higher fecundity and survival are indicators of higher relative fitness. We manipulated water temperature in indoor mesocosms to 16℃, 22℃, 26℃, 28℃, and 30℃. The water temperature of warm treatments was manipulated using aquaria heaters. The 16℃ was manipulated by putting the mesocosms in coolers surrounded with ice packs that were replaced twice a day. This cooled the water temperature externally without adding ice directly into the water. The experiment was conducted in 2 temporally overlapping blocks. In the first block, 3 individually separated backswimmers were added to each mesocosm and in the second block 2 additional individually separated backswimmers were added to each mesocosm. Each temperature treatment had 8 replicates, totalling 48 mesocosms and 240 backswimmers. Each cup contained a black zip tie as structure for the backswimmer. Backswimmers lay white eggs on available structure, the black zip tie provides contrast which allows us to easily count eggs laid. Every other day for 2 weeks we removed and replaced the zip ties in each cup for data collection and to create room for more eggs to be laid. We recorded the number of eggs on each zip tie when it was removed. This data was used to create total reproductive output (total number of eggs laid) and reproductive rate (average number of eggs laid per day). Survival was assessed throughout the experiment. At the end of the experiment, we calculated body condition the backswimmer mass (g) divided by body size (thorax width, mm). Backswimmers were fed zooplankton and mosquito larvae which was replenished ad lib. 

### Phase 2 - Dispersal assay
The dispersal assay was conducted using an outdoor mesocosm field experiment. The temperatures 16℃, 26℃, and 30℃ were chosen for the dispersal assay with 6 replicates of each treatment (18 total mesocosms). For the 26℃ and 30℃ treatments, water temperature was manipulated using aquaria heaters. To keep the 16℃ treatment below ambient temperatures, the mesocosms were wrapped in insulation with ice packs between the insulation and mesocosm, the ice packs were switched out twice a day. Backswimmers were separated into individual cups throughout the experiment, with 13 backswimmers per mesocosm (234 backswimmers total). Dispersal is dichotomous and can be determined from the presence-absence of a backswimmer from a cup, if a backswimmer is absent it is assumed to have dispersed via flight. Backswimmers were labeled on one hemelytron with their assigned mesocosm number to identify if short distance dispersal (flight from between mesocosms) occurred. Backswimmers were fed zooplankton and mosquito larvae which was replenished ad lib. 
This phase used separate individuals from Phase 1, including randomly sampled adult backswimmers regardless of sex collected in August. Since interspecific interactions such as density (Baines et al. 2014) and cannibalism (Regimbal and Baines 2024) influence dispersal, the backswimmers remained individually separated to isolate the independent effects of temperature on dispersal. Backswimmers acclimated to their temperature treatments for 4 days, during which each backswimmer cup was covered with mesh to prevent dispersal and the mesocosms covered to prevent light cues which may induce dispersal attempts. The backswimmers then underwent a 2 week dispersal assay where the backswimmer containers were uncovered allowing dispersal to occur. We assessed dispersal and survival every day during this period. 

###	Temperature treatments
For Phase 1, we chose 5 temperature treatments of 16℃, 22℃, 26℃, 28℃, and 30℃. Based on our results of how temperature affects reproduction in Phase 1, we chose the three temperatures of 16℃, 26℃, and 30℃; such that 26℃ is Topt.


```{r instructions2, echo = F}

# 11. Knit RMarkdown

## Now it is time to knit the RMarkdown document. Open the render_script document in the species folder and run that script (see README.md for additional instructions). It will automatically write the files to the correct folders in the repository. Remember not to 'run all' in the RMarkdown. You will get an error.

# 12. Check diagnostics

## The final section of the output doc will be model diagnostics. Check the output word doc (it will be in the 'Knitted_Markdowns' folder) for any issues and re-run the render_script if necessary after selecting different options in the RMarkdown (e.g., does the fitness variable need to be transformed? Is there overdispersion in the dispersal data?)

## You should also check the word doc for warning messages for the models (e.g., singularity in mixed models). These (if there are any) will print in the knitted doc next to the model results.

## If problems persist, the way the analysis is done may have to be changed (check in with Celina).

## Note that the current default description of the diagnostics is: "There was no evidence for lack of fit for either the fitness or the dispersal model." Change this as needed.


#############

# YOU ARE DONE! NO NEED TO FILL IN OR CHANGE ANYTHING BELOW.

############

```

## Statistical Analysis

```{r loaddata, echo = F}

# Set reading and writing paths; Do not change these paths
reading.path <- ("./")

writing.path <- ("../outputs/")

# load data file
d_phase1 <- read.csv(paste("Phase1_fitness_", Genus, ".", species, ".csv", sep = ""))
d_phase2 <- read.csv(paste("Phase2_dispersal_", Genus, ".", species, ".csv", sep = ""))

d_phase1 <- within(d_phase1, Temp.treatment <- relevel(as.factor(Temp.treatment), ref = "opt"))
d_phase2 <- within(d_phase2, Temp.treatment <- relevel(as.factor(Temp.treatment), ref = "opt"))

d_phase2 <- d_phase2 %>%
  { if (filter.dead) filter(., Survived == "Y") else . }

```

```{r writedata, echo = F}

# specify fitness and dispersal file names
fitpath <- paste("Phase1_fitness_", Genus, ".", species, ".csv", sep = "")
disppath <- paste("Phase2_dispersal_", Genus, ".", species, ".csv", sep = "")

data_path <- "../raw_data/" #path to save the data is to the raw_data folder

#save copy of final dfs used in this file to the raw_data folder
write.csv(d_phase1, paste(data_path, fitpath, sep = ""), row.names = FALSE)
write.csv(d_phase2, paste(data_path, disppath, sep = ""), row.names = FALSE)

```


### Does fitness change with temperature (phase 1)?

`r ifelse(fitness.transformed.normal == TRUE, print(paste(fitness.proxy, " was not normally distributed so we ", transform.description, "-transformed it. The transformed variable followed a normal distribution.", sep = "")), ifelse(fitness.normal == TRUE, print(paste(fitness.proxy, "was normally distributed.")), print(paste("The fitness proxy,", tolower(fitness.proxy), ", was a binary variable."))))`

```{r fitnessnormal, eval = fitness.normal, echo = F, fig.cap = paste("Figure 1. Histogram of fitness (", tolower(fitness.proxy), ") values.")}

# histogram showing fitness proxy was normally distributed

with(d_phase1, hist(Fitness, xlab = fitness.proxy, main = NULL))

```


```{r transformedfitnessnormal, eval = fitness.transformed.normal, echo = F, fig.cap = paste("Figure 1. Histogram of", transform.description, "-transformed", tolower(fitness.proxy), "values.")}

# histogram showing transformed fitness proxy was normally distributed

with(d_phase1, hist(fitness.transformation.function(Fitness), xlab = paste(transform.description, "-transformed ", tolower(fitness.proxy), sep = ""), main = NULL))

```

```{r fitnessplotnormal, eval = fitness.normal | fitness.transformed.normal, echo = F, message = F, fig.cap = paste("Figure 2. Boxplot of fitness (", tolower(fitness.proxy), "), as a function of temperature treatment. low = ", low.temp, "C, opt = ", opt.temp, "C, high = ", high.temp, "C.")}

# plot fitness data

ggplot(d_phase1, aes(x = Temp.treatment, y = Fitness, col = Temp.treatment))+
  geom_boxplot()+
  scale_x_discrete("Temperature treatment", limits = c("low", "opt", "high"))+
  scale_color_manual(values = c("darkgreen", "red", "blue"), guide = "none")+
  theme_classic(base_size = 15)

```

`r ifelse(fitness.binary == T, print(paste("To estimate the effects of temperature (a factor) on fitness we used a generalized linear mixed model with a logit link and", tolower(fitness.proxy), "as the binary response variable. We used the formula:")), paste("To estimate the effects of temperature (a factor) on fitness, we used a linear mixed model with", tolower(fitness.proxy), "as the response variable. We used the formula:"))`  

`r (print(fitness.formula))`

```{r fitnessmodelnormal, eval = fitness.normal | fitness.transformed.normal, echo = F}

# model testing effects of temperature on fitness

m_fitness <- lmer(fitness.formula, data = d_phase1)

# output results for overall model and pairwise comparisons

output_fitness_Tempeffect <- anova(m_fitness)
output_fitness_summary <- summary(m_fitness)
output_fitness_emmeans <- emmeans(m_fitness, specs = pairwise ~ Temp.treatment, regrid = "response", adjust = "none")
output_fitness_contrasts <- output_fitness_emmeans$contrasts %>%
     summary(infer = TRUE)
```


```{r fitnesstablebinary, eval = fitness.binary, echo = F}

fittable <- with(d_phase1, table(Temp.treatment, Fitness))
knitr::kable(fittable, col.names = c(Fit0, Fit1),
 caption = paste("Table 1. Relationship between", tolower(fitness.proxy), "and temperature treatment.")) 


```


```{r fitnessmodelbinary, eval = fitness.binary, echo = F}

# model testing effects of temperature on fitness

m_fitness <- glmer(fitness.formula, family = binomial, data = d_phase1)

# output results for overall model and pairwise comparisons

output_fitness_Tempeffect <- drop1(m_fitness, test = "Chisq")
output_fitness_summary <- summary(m_fitness)
output_fitness_emmeans <- emmeans(m_fitness, specs = pairwise ~ Temp.treatment, type = "response", adjust = "none")
output_fitness_contrasts <- output_fitness_emmeans$contrasts %>%
     summary(infer = TRUE)

```

#### Results for main effect of temperature on fitness
```{r fitnessresultsmaineffect, echo = F}

output_fitness_Tempeffect

```

#### Post-hoc pairwise contrasts: differences in fitness between temperature treatments
```{r fitnessresultscontrasts, echo = F}

output_fitness_contrasts

```


### Does dispersal change with temperature (phase 2)?

`r ifelse(!overdispersion, print("To estimate the effect of temperature treatment (a factor) on dispersal, we used a generalized linear mixed model with a binomial error structure and a logit link. Dispersal (the number of dispersers vs non-dispersers) was the response variable. We used the formula:"), print("There was evidence of overdispersion in our dispersal data. Therefore, to estimate the effect of temperature treatment (a factor) on dispersal, we used a generalized linear mixed model with a negative binomial error structure. Dispersal (the number of dispersers vs non-dispersers) was the response variable. We used the formula:"))`  

`r (print(dispersal.formula))`


```{r dispersalmodelbinomial, eval = !overdispersion, echo = F}

# binomial model testing effects of temperature on dispersal

m_dispersal <- glmer(dispersal.formula, family = "binomial", data = d_phase2)

# output results for overall model and pairwise comparisons
output_dispersal_Tempeffect <- drop1(m_dispersal, test = "Chisq")
output_dispersal_summary <- summary(m_dispersal)
output_dispersal_emmeans <- emmeans(m_dispersal, specs = pairwise ~ Temp.treatment, type = "response", adjust = "none")
output_dispersal_contrasts <- output_dispersal_emmeans$contrasts %>%
  summary(infer = TRUE)


```

```{r dispersalmodelnegbinomial, eval = overdispersion, echo = F}

# negative binomial model testing effects of temperature on dispersal

m_dispersal <- glmer.nb(dispersal.formula, data = d_phase2)

# output results for overall model and pairwise comparisons
output_dispersal_Tempeffect <- drop1(m_dispersal, test = "Chisq")
output_dispersal_summary <- summary(m_dispersal)
output_dispersal_emmeans <- emmeans(m_dispersal, specs = pairwise ~ Temp.treatment, type = "response", adjust = "none")
output_dispersal_contrasts <- output_dispersal_emmeans$contrasts %>%
  summary(infer = TRUE)

```

```{r dispersalplot, echo = F, warning = F, fig.cap = paste("Figure 1. Dispersal as a function of temperature treatment. low = ", low.temp, "C, opt = ", opt.temp, "C, high = ", high.temp, "C. Error bars represent 95% confidence intervals predicted from GLMM.")}

# plot dispersal data

ggplot(as.data.frame(output_dispersal_emmeans$emmeans), aes(x = Temp.treatment, y = prob, col = Temp.treatment))+
  geom_point(size = 4)+
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0)+
  scale_x_discrete("Temperature treatment", limits = c("low", "opt", "high"))+
  scale_y_continuous("Dispersal probability")+
  scale_color_manual(values = c("darkgreen", "red", "blue"), guide = "none")+
  theme_classic(base_size = 15)

```

#### Results for main effect of temperature on dispersal
```{r dispersalresultsmaineffect, echo = F}

output_dispersal_Tempeffect

```

#### Post-hoc pairwise contrasts: differences in dispersal between temperature treatments
```{r dispersalresultscontrasts, echo = F}

output_dispersal_contrasts

```

### Model Diagnostics

There was no evidence for lack of fit for either the fitness or the dispersal model.

#### Diagnostic plots for fitness data

```{r modeldiagnosticsfitness, echo = F, fig.width = 8, fig.height = 7}

diagnostic_fitness <- simulateResiduals(fittedModel = m_fitness)
plot(diagnostic_fitness)
```

#### Diagnostic plots for dispersal data

```{r modeldiagnosticsdispersal, echo = F, fig.width = 8, fig.height = 7}

diagnostic_dispersal <- simulateResiduals(fittedModel = m_dispersal)
plot(diagnostic_dispersal)

```

```{r moderators, echo = F}

d_moderator <- data.frame(
  "Species" = paste(Genus, species),
  "Taxonomic group" = taxonomic.group,
  "Rearing.environment" = rearing.environment,
  "Competition.strength" = comp.strength,
  "Source" = source,
  "Habitat" = habitat,
  "Temperature.variation" = Tvariation,
  "Species mean body size" = species.body.size,
  "Passive.dispersal" = passive.dispersal,
  "Inbred.or.Mixed" = inbred,
  "Dispersal.assay.duration" = disp.assay.duration,
  "Fitness.proxy.type" = fitness.proxy.type
)

```

```{r writingoutputfiles, echo = F}

# fitness output

write.table(output_fitness_Tempeffect, paste(writing.path, "output_fitness_TempMain_", Genus, ".", species, ".txt", sep = ""))

write.table(output_fitness_summary$coefficients, paste(writing.path, "output_fitness_Summary_", Genus, ".", species, ".txt", sep = ""))

write.table(output_fitness_emmeans$emmeans, paste(writing.path, "output_fitness_emmeans_", Genus, ".", species, ".txt", sep = ""))

write.table(output_fitness_emmeans$contrasts, paste(writing.path, "output_fitness_contrasts_", Genus, ".", species, ".txt", sep = ""))


# dispersal output

write.table(output_dispersal_Tempeffect, paste(writing.path, "output_dispersal_TempMain_", Genus, ".", species, ".txt", sep = ""))

write.table(output_dispersal_summary$coefficients, paste(writing.path, "output_dispersal_Summary_", Genus, ".", species, ".txt", sep = ""))

write.table(output_dispersal_emmeans$emmeans, paste(writing.path, "output_dispersal_emmeans_", Genus, ".", species, ".txt", sep = ""))

write.table(output_dispersal_emmeans$contrasts, paste(writing.path, "output_dispersal_contrasts_", Genus, ".", species, ".txt", sep = ""))


# moderator output

write.table(d_moderator, paste(writing.path, "moderators_", Genus, ".", species, ".txt", sep = ""))

```
