---
title: "Temperature dependent dispersal: A distributed experiment"
author: "researcher names here"
output: 
  word_document: default
editor_options: 
  chunk_output_type: console
---

```{r instructions, echo = F, warning = F}

# INSTRUCTIONS FOR RESEARCHERS

# Here, you'll find instructions and information to fill out about your species. Once you have finished following the instructions, simply knit (output Word document, please) and the appropriate analyses for your data will run automatically. Do not try to "run all" within R, you will get an error. You don't need to make any changes to the analysis outside of this code chunk, but feel free to do so if it's appropriate for your species. If you make substantive changes to either of the models, please flag it for Celina.

# 0. Add names of researchers who worked on this species to author list above

# 1. Before starting, make sure your data files are named:
# Phase1_fitness_Genus.species.csv
# Phase2_dispersal_Genus.species.csv

## code below assumes .csv format (only in the code chunk named 'loaddata'; You can change this if you would rather not use .csv)


# 2. Install any missing libraries from the list below:
library(tidyverse)
library(lme4)
library(ggplot2)
library(emmeans)
library(DHARMa)

# 3. Fill out information about your species below

Genus = "Notonecta"
species = "undulata"
fitness.proxy = "Fecundity"
low.temp = 16 #value of low temperature treatment in Celsius
opt.temp = 26 #value of optimal temperature treatment in Celsius
high.temp = 30 #value of high temperature treatment in Celsius


# 4. Set paths

reading.path <- ("./")

writing.path <- ("../outputs/")

# 5. Check that the data files have the following headers (order of columns is not important):

## phase1 : Temp.treatment (levels = low, opt, high), Temp.value (in degrees C), random effects (name as appropriate), Fitness
### It's important to give the column of the fitness variable the header "Fitness". You have already provided a description of the fitness proxy which will be used in the knitted document.

## phase 2:

### If your phase 2 data are formatted with mesocosms as rows and number of dispersers/number of non-dispersers as columns, then these headers:
#### Temp.treatment (levels = low, opt, high), Temp.value (in degrees C), random effects (name as appropriate), Num.disp, Num.nondisp (or alternatively, Num.disp and total N)

### If your phase 2 data are formatted with individuals as rows and a dispersed column (0s and 1s) giving dispersal status for each individual, then these headers:
#### Temp.treatment (levels = low, opt, high), Temp.value (in degrees C), random effects (name as appropriate), Dispersed

# note that the datasets can also include fixed effects and phenotypes, as appropriate for your study

# 6. Type of fitness data

## Answer questions below about the fitness proxy

### Is your fitness variable binary? (choose one)
fitness.binary = FALSE

### Is the fitness variable continuous normal (without transformation)? (choose one)
fitness.normal = FALSE

### Is the fitness variable normal after transformation? (choose one; choose NA if you said "TRUE" to either question above)
fitness.transformed.normal = TRUE

## If fitness variable is continuous normal AFTER transformation, choose transformation used (just write it in if not on this list):

transform.description <- "log(x+1)"
fitness.transformation.function <- function(x) {return (log(x + 1))} # give transformation formula here; replace XYZ with transformation e.g., sqrt(x) or log(x + 1), etc., where x will be Fitness, below

## note: if fitness (or transformed fitness) does not have a binomial or normal distribution, check in with Celina.

# 7. Structure of dispersal data

## Are there dead individuals that should be removed from the dispersal data?

filter.dead = TRUE

## Is there overdispersion in the dispersal data? If you do not yet know, choose FALSE and this will be dealt with in step 10.

overdispersion = FALSE

# 8. Dealing with mortality in dispersal assay

## note on mortality: everyone will deal with mortality during the dispersal assay in a slightly different way. If individuals are rows in your dataset, you may have a row that indicates "Survived" (Y/N) through the entire experiment. In this case, you can move to the 'loaddata' code chunk and "uncomment" the line of code there to filter out dead individuals after the dataset is loaded. If mesocosms are rows in your dataset, you may have a column indicating the number of individuals that died. In this case, dead individuals can be excluded directly in the dispersal formula (e.g., (Num.disp, TotalN-(Num.disp+Num.dead))).

## Make sure to describe how you dealt with mortality in the methods below.

## If you are unsure how to handle mortality in your dataset, check with Celina.


# 9. Model formulae

## Formula for fitness: (fill in as appropriate)

fitness.formula <- "log(Fitness + 1) ~ Temp.treatment + (1|Block/Mesocosm)"

### notes:
#### TRANSFORM FITNESS VARIABLE (if needed) *WITHIN* THE FORMULA; doing it within the formula is important for contrasts below  
#### other.fixed.effects does not apply to every species; include as appropriate; fixed effects should be standardized
#### include as many random effects as appropriate
#### Fitness can be normal or binary, including 0s and 1s or cbind(number.survived, number.dead)

### If fitness is binary:

### What do Fitness = 0 and Fitness = 1 mean?

Fit0 <- "Died/Survived" # or fill in other
Fit1 <- "Died/Survived" # or fill in other

## Formula for dispersal: (fill in as appropriate)
  
dispersal.formula <- "Dispersal ~ Temp.treatment + (1|Mesocosm)"

### notes
#### other.fixed.effects does not apply to every species; include as appropriate; fixed effects should be standardized
#### include as many random effects as appropriate
#### Num.disp/Num.nondisp can be replaced with column "Dispersed" with values 0 and 1, if individuals are rows in your dataset

# 10. Moderators

## Collecting data on all proposed moderators; we will use a subset of these in the analysis
## choose option on right hand side
## see description of moderators and levels in analysis info doc

taxonomic.group <- "notonectidae"
rearing.environment <- "field"
comp.strength <- "moderate"
source <- "field" # lab population or field caught
habitat <- "aquatic"
Tvariation <- "heterogenous"
species.body.size <- 10 # mean body length in mm
passive.dispersal <- "No"
inbred <- "mixed"
disp.assay.duration <- 0.01 # order of magnitude for dispersal assay duration / generation time, i.e., approximate number of generations the dispersal assay lasted
fitness.proxy.type <- "other"

# 11. Fill out methods information below.

```


# Supplementary methods for *`r (print(paste(Genus, species)))`*

## Study organism
Name and strain/origin of species.  

Provide basic life history information (aquatic/terrestrial, mode of dispersal, lifespan, etc.).  

Briefly describe what is known about the temperature range the species experiences (geographic range, seasonality, type of habitat, etc.) in its natural system or the history of the conditions it has experienced in the lab.  

How were organisms sourced?  
-	Field caught: provide information on timing, geographic coordinates, type of habitat.  
-	Lab sourced: provide information on source.  
-	Provide license/ authorization numbers for catching animals in the field and/or doing experiments, where applicable. 

How were individuals/populations treated before the experiment?  
-	Rearing/holding conditions (temperature, food, light).  
-	How long were experimental subjects held before the experiment?  

Were specific individuals/phenotypes/stages selected for the experiment?  

## Study design

### Temperature treatments

State the temperatures used for T~opt~, T~hot~, T~cold~, and explain how they were chosen.  

State whether there was daily variation in temperature, and if so, describe (e.g., mean and standard deviation temperature for each treatment).  

### Phase 1: Fitness assay

Describe the fitness proxy (growth rate, survival, body condition, reproductive output, etc.). If proxy is indirect (e.g., body condition), explain what is known about the relationship between the proxy and actual fitness in the species.  

Provide details about the methods for estimating the fitness proxy including:  
-	Physical details about the experimental setup including size/shape/volume of experimental arenas, substrate/medium of experimental arenas.  
-	Replicates  
    - Specify number of experimental replicates  
    - Number of strains and number of replicates per strain  
    - Indicate if experimental blocks were used and the blocking design (number of blocks, how many replicates of each treatment per block, time/space between blocks)  
-	Type and amount of food provided during experiment  
- Starting density  
-	Duration of fitness assay  
-	Controlled variables: food (ad lib?), water (ad lib?), sex ratio  
- Phenotypes measured (activity, body condition, body size, etc.) and how they were estimated  

### Phase 2: Dispersal assay

Provide details about the methods for estimating dispersal including:  
-	Physical details about the experimental setup including size/shape/volume of experimental arenas, substrate/medium of experimental arenas, type of system (1 or 2 patches).  
-	Replicates  
    - Specify number of experimental replicates  
    - Number of strains and number of replicates per strain  
    - Indicate if experimental blocks were used and the blocking design (number of blocks, how many replicates of each treatment per block, time/space between blocks)  
-	Type and amount of food provided during experiment  
- Starting density  
-	Duration of dispersal assay including:  
    - time between birth and start of acclimation period  
    - duration of acclimation period  
    - timing and duration of dispersal assay  
-	Controlled variables: food (ad lib), water (ad lib if applicable), sex ratio  
- Phenotypes measured (activity, body condition, body size, etc.) and how they were estimated  
- Whether individuals used in phase 2 were the same as used in phase 1 (note that the same individuals do NOT have to be used for phase 1 and phase 2)  
- Provide details on data collection including:  
    -	The sampling regime (time intervals between sampling).  
    -	Sampling method including whether individuals were marked and whether sampling was observed or automated. Please include validation if automated.  
- State whether mortality during the dispersal assay was recorded. Describe how mortality was handled for the statistical analysis (e.g., individuals that died during the dispersal assay were excluded from the analysis of dispersal).  



```{r instructions2, echo = F}

# 12. Knit RMarkdown

## Now it is time to knit the RMarkdown document. Please knit to word so I can combine into one Supplement document.

# 13. Check diagnostics

## The final section of the doc will be model diagnostics. Check if there are any issues and re-knit RMarkdown if necessary with different options (e.g., does fitness variable need to be transformed? Is there overdispersion in the dispersal data?)

## You should also check the word doc for warning messages for the mdoels (e.g., singularity in LMMs) that will print next to the results outputs, if any.

## If problems persist, the way the analysis is done may have to be changed (check in with Celina).

## Note that the current default description of the diagnostics is: "There was no evidence for lack of fit for either the fitness or the dispersal model." Change this as needed.

# 14. When diagnostics look good, push files to github (see github instructions).


#############

# YOU ARE DONE! NO NEED TO FILL IN OR CHANGE ANYTHING BELOW.

############

```

## Statistical Analysis

```{r loaddata, echo = F}

# load data file
d_phase1 <- read.csv(paste("Phase1_fitness_", Genus, ".", species, ".csv", sep = ""))
d_phase2 <- read.csv(paste("Phase2_dispersal_", Genus, ".", species, ".csv", sep = ""))


d_phase1 <- within(d_phase1, Temp.treatment <- relevel(as.factor(Temp.treatment), ref = "opt"))

d_phase2 <- within(d_phase2, Temp.treatment <- relevel(as.factor(Temp.treatment), ref = "opt"))



#d_phase2 <- d_phase2 %>%
#  { if (filter.dead) filter(., Survival == 1) else . }

#d_phase2 <- d_phase2 %>% filter(Survived == "Y") # exclude dead individuals if needed

```

```{r writedata, echo = F}

# load data file from github directory
fitpath <- paste("Phase1_fitness_", Genus, ".", species, ".csv", sep = "") #specify file name for fitness
disppath <- paste("Phase2_dispersal_", Genus, ".", species, ".csv", sep = "")

data_path <- "../raw_data/"

write.csv(d_phase1, paste(data_path, fitpath, sep = ""), row.names = FALSE)
write.csv(d_phase2, paste(data_path, disppath, sep = ""), row.names = FALSE)

#setwd(paste("./",folder, sep = ""))
#folder <- paste("./", Genus, "_", species, "/", sep = "") #specify folder in git repo


#fitdf <- read_csv(paste(fitpath)) #read in fitness file from github path
#dispdf <- read_csv(paste(folder, disppath, sep = "")) #read in dispersal file from github path

#fitdf <- read.csv("Phase1_fitness_Notonecta.undulata.csv") #read in fitness file from github path
#dispdf <- read_csv(disppath) #read in dispersal file from github path

#setwd("./raw_data/")

#write.csv(d_phase1, "../raw_data/Notofit1.csv", row.names = FALSE) #copy the raw data csv to the raw data folder

#write.csv(fitdf, file = paste("raw_data/", fitpath)) #copy the raw data csv to the raw data folder

#write.csv(dispdf, file = paste("./raw_data/", disppath))

```


```{r setup, include = F}

knitr::opts_knit$set(root.dir = normalizePath(reading.path))
#knitr::opts_knit$set(root.dir = normalizePath(dir()))
```


### Does fitness change with temperature (phase 1)?

`r ifelse(fitness.transformed.normal == TRUE, print(paste(fitness.proxy, " was not normally distributed so we ", transform.description, "-transformed it. The transformed variable followed a normal distribution.", sep = "")), ifelse(fitness.normal == TRUE, print(paste(fitness.proxy, "was normally distributed.")), print(paste("The fitness proxy,", tolower(fitness.proxy), ", was a binary variable."))))`

```{r fitnessnormal, eval = fitness.normal, echo = F, fig.cap = paste("Figure 1. Histogram of fitness (", tolower(fitness.proxy), ") values.")}

# histogram showing fitness proxy was normally distributed

with(d_phase1, hist(Fitness, xlab = fitness.proxy, main = NULL))

```


```{r transformedfitnessnormal, eval = fitness.transformed.normal, echo = F, fig.cap = paste("Figure 1. Histogram of", transform.description, "-transformed", tolower(fitness.proxy), "values.")}

# histogram showing transformed fitness proxy was normally distributed

with(d_phase1, hist(fitness.transformation.function(Fitness), xlab = paste(transform.description, "-transformed ", tolower(fitness.proxy), sep = ""), main = NULL))

```

```{r fitnessplotnormal, eval = fitness.normal | fitness.transformed.normal, echo = F, message = F, fig.cap = paste("Figure 2. Boxplot of fitness (", tolower(fitness.proxy), "), as a function of temperature treatment. low = ", low.temp, "C, opt = ", opt.temp, "C, high = ", high.temp, "C.")}

# plot fitness data

ggplot(d_phase1, aes(x = Temp.treatment, y = Fitness, col = Temp.treatment))+
  geom_boxplot()+
  scale_x_discrete("Temperature treatment", limits = c("low", "opt", "high"))+
  scale_color_manual(values = c("darkgreen", "red", "blue"), guide = "none")+
  theme_classic(base_size = 15)

```

`r ifelse(fitness.binary == T, print(paste("To estimate the effects of temperature (a factor) on fitness we used a generalized linear mixed model with a logit link and", tolower(fitness.proxy), "as the binary response variable. We used the formula:")), paste("To estimate the effects of temperature (a factor) on fitness, we used a linear mixed model with", tolower(fitness.proxy), "as the response variable. We used the formula:"))`  

`r (print(fitness.formula))`

```{r fitnessmodelnormal, eval = fitness.normal | fitness.transformed.normal, echo = F}

# model testing effects of temperature on fitness

m_fitness <- lmer(fitness.formula, data = d_phase1)

# output results for overall model and pairwise comparisons

output_fitness_Tempeffect <- anova(m_fitness)
output_fitness_summary <- summary(m_fitness)
output_fitness_emmeans <- emmeans(m_fitness, specs = pairwise ~ Temp.treatment, regrid = "response", adjust = "none")
output_fitness_contrasts <- output_fitness_emmeans$contrasts %>%
     summary(infer = TRUE)
```

```{r fitnesstablebinary, eval = fitness.binary, echo = F}

fittable <- with(d_phase1, table(Temp.treatment, Fitness))
knitr::kable(fittable, col.names = c(Fit0, Fit1),
 caption = paste("Table 1. Relationship between", tolower(fitness.proxy), "and temperature treatment.")) 

```


```{r fitnessmodelbinary, eval = fitness.binary, echo = F}

# model testing effects of temperature on fitness

m_fitness <- glmer(fitness.formula, family = binomial, data = d_phase1)

# output results for overall model and pairwise comparisons

output_fitness_Tempeffect <- drop1(m_fitness, test = "Chisq")
output_fitness_summary <- summary(m_fitness)
output_fitness_emmeans <- emmeans(m_fitness, specs = pairwise ~ Temp.treatment, type = "response", adjust = "none")
output_fitness_contrasts <- output_fitness_emmeans$contrasts %>%
     summary(infer = TRUE)

```


#### Results for main effect of temperature on fitness
```{r fitnessresultsmaineffect, echo = F}

output_fitness_Tempeffect

```

#### Post-hoc pairwise contrasts: differences in fitness between temperature treatments
```{r fitnessresultscontrasts, echo = F}

output_fitness_contrasts

```


### Does dispersal change with temperature (phase 2)?

To estimate the effect of temperature treatment (a factor) on dispersal, we used a generalized linear mixed model with a binomial error structure and a logit link. Dispersal (the number of dispersers vs non-dispersers) was the response variable. We used the formula:

`r (print(dispersal.formula))`


```{r dispersalmodelbinomial, eval = !overdispersion, echo = F}

# binomial model testing effects of temperature on dispersal

m_dispersal <- glmer(dispersal.formula, family = "binomial", data = d_phase2)

# output results for overall model and pairwise comparisons
output_dispersal_Tempeffect <- drop1(m_dispersal, test = "Chisq")
output_dispersal_summary <- summary(m_dispersal)
output_dispersal_emmeans <- emmeans(m_dispersal, specs = pairwise ~ Temp.treatment, type = "response", adjust = "none")
output_dispersal_contrasts <- output_dispersal_emmeans$contrasts %>%
  summary(infer = TRUE)


```

```{r dispersalmodelnegbinomial, eval = overdispersion, echo = F}

# negative binomial model testing effects of temperature on dispersal

m_dispersal <- glmer.nb(dispersal.formula, data = d_phase2)

# output results for overall model and pairwise comparisons
output_dispersal_Tempeffect <- drop1(m_dispersal, test = "Chisq")
output_dispersal_summary <- summary(m_dispersal)
output_dispersal_emmeans <- emmeans(m_dispersal, specs = pairwise ~ Temp.treatment, type = "response", adjust = "none")
output_dispersal_contrasts <- output_dispersal_emmeans$contrasts %>%
  summary(infer = TRUE)

```

```{r dispersalplot, echo = F, warning = F, fig.cap = paste("Figure 1. Dispersal as a function of temperature treatment. low = ", low.temp, "C, opt = ", opt.temp, "C, high = ", high.temp, "C. Error bars represent 95% confidence intervals predicted from GLMM.")}

# plot dispersal data

ggplot(as.data.frame(output_dispersal_emmeans$emmeans), aes(x = Temp.treatment, y = prob, col = Temp.treatment))+
  geom_point(size = 4)+
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0)+
  scale_x_discrete("Temperature treatment", limits = c("low", "opt", "high"))+
  scale_y_continuous("Dispersal probability")+
  scale_color_manual(values = c("darkgreen", "red", "blue"), guide = "none")+
  theme_classic(base_size = 15)

```

#### Results for main effect of temperature on dispersal
```{r dispersalresultsmaineffect, echo = F}

output_dispersal_Tempeffect

```

#### Post-hoc pairwise contrasts: differences in dispersal between temperature treatments
```{r dispersalresultscontrasts, echo = F}

output_dispersal_contrasts

```

### Model Diagnostics

There was no evidence for lack of fit for either the fitness or the dispersal model.

#### Diagnostic plots for fitness data

```{r modeldiagnosticsfitness, echo = F, fig.width = 8, fig.height = 7}

diagnostic_fitness <- simulateResiduals(fittedModel = m_fitness)
plot(diagnostic_fitness)
```

#### Diagnostic plots for dispersal data

```{r modeldiagnosticsdispersal, echo = F, fig.width = 8, fig.height = 7}

diagnostic_dispersal <- simulateResiduals(fittedModel = m_dispersal)
plot(diagnostic_dispersal)

```

```{r moderators, echo = F}

d_moderator <- data.frame(
  "Species" = paste(Genus, species),
  "Taxonomic group" = taxonomic.group,
  "Rearing.environment" = rearing.environment,
  "Competition.strength" = comp.strength,
  "Source" = source,
  "Habitat" = habitat,
  "Temperature.variation" = Tvariation,
  "Species mean body size" = species.body.size,
  "Passive.dispersal" = passive.dispersal,
  "Inbred.or.Mixed" = inbred,
  "Dispersal.assay.duration" = disp.assay.duration,
  "Fitness.proxy.type" = fitness.proxy.type
)

```

```{r writingoutputfiles, echo = F}

# fitness output

write.table(output_fitness_Tempeffect, paste(writing.path, "output_fitness_TempMain_", Genus, ".", species, ".txt", sep = ""))

write.table(output_fitness_summary$coefficients, paste(writing.path, "output_fitness_Summary_", Genus, ".", species, ".txt", sep = ""))

write.table(output_fitness_emmeans$emmeans, paste(writing.path, "output_fitness_emmeans_", Genus, ".", species, ".txt", sep = ""))

write.table(output_fitness_emmeans$contrasts, paste(writing.path, "output_fitness_contrasts_", Genus, ".", species, ".txt", sep = ""))


# dispersal output

write.table(output_dispersal_Tempeffect, paste(writing.path, "output_dispersal_TempMain_", Genus, ".", species, ".txt", sep = ""))

write.table(output_dispersal_summary$coefficients, paste(writing.path, "output_dispersal_Summary_", Genus, ".", species, ".txt", sep = ""))

write.table(output_dispersal_emmeans$emmeans, paste(writing.path, "output_dispersal_emmeans_", Genus, ".", species, ".txt", sep = ""))

write.table(output_dispersal_emmeans$contrasts, paste(writing.path, "output_dispersal_contrasts_", Genus, ".", species, ".txt", sep = ""))

# moderator output

write.table(d_moderator, paste(writing.path, "moderators_", Genus, ".", species, ".txt", sep = ""))

```
